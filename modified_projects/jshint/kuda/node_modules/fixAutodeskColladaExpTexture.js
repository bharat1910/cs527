/* jshint undef: true, unused: true */

// The following changes were made to these files to stop the uppercase and lowercase madness!!!
//
// node_modules/jsdom/lib/jsdom/browser/index.js
// Patch jsdom to no uppercase the node names. It does this for html as a defaults
// dom.Element.prototype.__defineGetter__('nodeName', function(val) {
//     return this._nodeName.toUpperCase(); // !!! remove the toUpperCase()
// });
// Patch jsdom to not uppercase the node names. It does this for html as defaults
// dom.Element.prototype.__defineGetter__('tagName', function(val) {
//     var t = this._tagName.toUpperCase(); // !!! remove the toUpperCase()
//     //Document should not return a tagName
//     if (this.nodeName === '#document') {
//       t = null;
//     }
//     return t;
// });
// node_modules/jsdom/lib/jsdom/browser/domtohtml.js
// exports.stringifyElement = function stringifyElement(element) {
//   var tagName = element.tagName.toLowerCase(), // !!! remove the toLowerCase()

var fs = require('fs'),
    jsdom = require('./jsdom/lib/jsdom').jsdom,
    domToHtml = require('./jsdom/lib/jsdom/browser/domtohtml').domToHtml;

exports.fixTexMissingSamplerSurface = function(filename) {
    var dae = fs.readFileSync(filename),
        doc = jsdom(dae),
        profile_commons = doc.getElementsByTagName("profile_COMMON");

    for (var i = 0; i < profile_commons.length; i++) {
        var profile_common = profile_commons[i],
            textures = profile_common.getElementsByTagName("texture");

        for (var j = 0; j < textures.length; j++) {
            var surface,sampler,element1,element2,
                texture = textures[j],
                textureAttr = texture.getAttribute("texture");

            img = doc.getElementById(textureAttr);

            if (img && img.nodeName == "image") {
                var surfaceRef = textureAttr + "-surface",
                    samplerRef = textureAttr + "-sampler";
        
                // Create surface entry
                element1 = doc.createElement("init_from");
                element1.textContent = textureAttr;

                element2 = doc.createElement("surface");
                element2.setAttribute("type", "2D")
                element2.appendChild(element1);
                
                surface = doc.createElement("newparam");
                surface.setAttribute("sid",surfaceRef);
                surface.appendChild(element2);
        
                // Create sampler entry
                element1 = doc.createElement("source");
                element1.textContent = surfaceRef;
        
                element2 = doc.createElement("sampler2D");
                element2.appendChild(element1);
        
                sampler = doc.createElement("newparam");
                sampler.setAttribute("sid", samplerRef);
                sampler.appendChild(element2);

                // Update texture reference
                texture.setAttribute("texture",samplerRef);

                profile_common.appendChild(sampler);
                profile_common.appendChild(surface);
            }
        }
    }

    // Using modified domtohtml.js, doesn't lowercase tags.
    var xml = domToHtml(doc);

    // Properly close tags
    xml = xml.replace(/<param(.+)>/g,"<param$1/>");
    xml = xml.replace(/<input(.+)>/g,"<input$1/>");
    xml = '<?xml version="1.0" encoding="utf-8"?>' + xml;
    return xml;
};

